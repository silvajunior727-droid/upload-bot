<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADVERBIAL CLAUSES!!!</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            color: #333;
        }

        .container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            min-height: 400px;
            box-sizing: border-box;
        }

        h1 { text-align: center; color: #dc3545; }
        h2 { text-align: center; color: #444; }

        .question-card, .results-card, .intro-card { display: none; flex-direction: column; }
        .intro-card { display: flex; text-align: center; }
        .intro-card input { padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        #student-code {
            text-transform: uppercase;
        }

        .progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 25px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { width: 0%; height: 20px; background-color: #007bff; text-align: center; line-height: 20px; color: white; font-weight: bold; transition: width 0.4s ease-in-out; }

        .audio-container {
            width: 100%;
            margin-bottom: 15px;
        }
        /* O player de √°udio fica funcional, mas escondido */
        .audio-container audio {
            display: none;
        }
        
        #audio-play-container {
            width: 100%;
            text-align: center; /* Centraliza o bot√£o */
            margin-bottom: 15px;
        }
        .audio-play-btn {
            background-color: #17a2b8; /* Cor ciano */
            color: white;
            font-size: 1.1rem;
            width: 80%;
            max-width: 300px;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .audio-play-btn:hover {
            background-color: #138496;
        }


        .question-text-wrapper {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.2rem;
            flex-grow: 1; 
            min-height: 50px; 
            display: flex;
            justify-content: flex-start; /* MODIFICADO: Alinha √† esquerda */
            align-items: center;
            text-align: left; /* MODIFICADO: Alinha o texto √† esquerda */
        }

        .translate-btn {
            background: transparent; 
            border: none;            
            color: #007bff;          
            font-size: 2.5rem;       
            cursor: pointer;
            flex-shrink: 0;
            padding: 0;
            margin: 0;
            line-height: 1;
            transition: transform 0.2s; 
        }
        .translate-btn:hover {
            transform: scale(1.15); 
        }
        .translate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }


        .translation-text {
            margin-top: -15px; 
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 5px solid #ffc107; 
            border-radius: 5px;
            font-style: italic;
            display: none; 
        }


        .options-list { list-style: none; padding: 0; margin: 0; }

        .option-item { background-color: #e9ecef; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, transform 0.3s; }
        .option-item:hover { background-color: #d1e7dd; }
        .option-item.correct { background-color: #28a745; color: white; transform: scale(1.02); }
        .option-item.incorrect { background-color: #dc3545; color: white; animation: shake 0.5s ease-in-out; }

        .justification { margin-top: 15px; padding: 15px; background-color: #f8f9fa; border-left: 5px solid #007bff; border-radius: 5px; display: block; }

        .btn, .next-btn, .skip-btn, .hint-btn { border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; text-decoration: none; display: inline-block; }
        .next-btn, .skip-btn { float: right; margin-left: 10px; }
        .next-btn { background-color: #007bff; color: white; display: none; }
        .skip-btn { background-color: #ffc107; color: #333; display: none; }
        .hint-btn { background-color: #6a0dad; color: white; float: none; }
        .hint-btn:disabled { background-color: #ccc; }

        .hint-text { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-left: 5px solid #6c757d; border-radius: 5px; font-style: italic; display: none; white-space: pre-wrap; }

        .question-actions { display: flex; justify-content: flex-end; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        
        .start-btn, .restart-btn, .send-report-btn, .print-btn, .share-btn, .save-report-btn, .continue-btn, .check-btn { display: inline-block; background-color: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 20px; text-align: center; text-decoration: none; }
        .start-btn, .continue-btn { animation: pulse 2s infinite; }
        
        .restart-btn { background-color: #dc3545; }
        .send-report-btn { background-color: #6c757d; }
        .print-btn { background-color: #17a2b8; } 
        .share-btn { background-color: #25d366; }
        .share-btn img { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; }
        .save-report-btn { background-color: #007bff; }

        .results-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .results-card h2 { margin-bottom: 20px; }
        .results-card p { font-size: 1.1rem; line-height: 1.5; }
        .results-card .score-display { font-size: 2rem; font-weight: bold; color: #007bff; }

        .question-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 15px; color: #555; }
        
        .full-report-list { margin-top: 30px; padding-top: 20px; border-top: 2px solid #ccc; }
        .full-report-list h3 { color: #007bff; }
        .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .report-question-item p { margin: 5px 0; }
        .report-question-item .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
        .report-question-item .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }

        .classification-red { color: red; }
        .classification-blue { color: #007bff; }
        .classification-orange { color: #FFA500; font-weight: bold; animation: blink-text 1s linear infinite; }

        .performance-btn { background-color: #FFA500; color: white; margin-right: auto; }
        .performance-display { width: 100%; margin-top: 10px; padding: 10px; background-color: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; font-weight: bold; color: #856404; text-align: left; }

        #fill-in-input { padding: 12px; width: 100%; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; }
        #fill-in-input.correct { border: 2px solid #28a745; background-color: #f0fffb; }
        #fill-in-input.incorrect { border: 2px solid #dc3545; background-color: #fff5f5; }
        .check-btn { background-color: #fca311; color: #14213d; float: left; }
        
        #drop-zone { padding: 15px 25px; border: 2px dashed #007bff; border-radius: 8px; background-color: #f8f9fa; display: inline-block; margin: 0 5px; transition: background-color 0.3s; min-width: 150px; text-align: center; font-style: italic; color: #6c757d; vertical-align: middle; }
        #drop-zone.over { background-color: #e0e9ed; }
        #drop-zone.correct { border-style: solid; border-color: #28a745; background-color: #d4edda; font-style: normal; color: #155724; }
        #drop-zone.incorrect { border-style: solid; border-color: #dc3545; background-color: #f8d7da; font-style: normal; color: #721c24; }
        
        .drag-options-wrapper { margin-top: 20px; text-align: center; }
        .drag-option { padding: 10px 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #e9ecef; cursor: move; margin: 5px; display: inline-block; user-select: none; }
        .drag-option.dragging { opacity: 0.5; }
        
        .personal-summary-item {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .personal-summary-item h4 {
            margin-top: 0;
            color: #856404;
        }
        .personal-summary-item p {
            font-size: 0.95rem;
            line-height: 1.5;
        }


        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink-text { 50% { opacity: 0; } }
        
        @media print { 
            body { background-color: #fff; padding-top: 0; display: block; }
            .container { box-shadow: none; border: none; width: 100%; max-width: none; }
            
            #intro-card, #quiz-card, .results-actions, .progress-bar-container, .question-header { 
                display: none !important; 
            }
            #results-card { display: block !important; }
            
            .full-report-list { 
                border-top: 1px solid #ccc; 
                padding-top: 10px; 
            }
            .report-question-item { page-break-inside: avoid; border: 1px solid #ddd; }
            
            #print-personal-btn {
                display: none !important;
            }
        }
        
        /* *** IN√çCIO DOS AJUSTES PARA CELULAR *** */
        @media (max-width: 600px) {
            body {
                padding-top: 15px; /* Reduz o padding superior */
            }

            .container {
                width: 95%; /* Ocupa mais a tela */
                padding: 15px; /* Reduz o padding interno */
                min-height: 0; /* Permite que o container seja menor */
            }

            h1 {
                font-size: 1.8rem;
            }
            h2 {
                font-size: 1.3rem;
            }

            .question-text {
                font-size: 1.1rem; /* Fonte da quest√£o ligeiramente menor */
            }

            .translate-btn {
                font-size: 2.0rem; /* Bot√£o de tradu√ß√£o um pouco menor */
                padding-left: 10px; /* Garante um espa√ßo */
            }

            .option-item {
                padding: 12px; /* Padding menor nas op√ß√µes */
            }

            .btn, .next-btn, .skip-btn, .hint-btn, .check-btn {
                padding: 14px 20px; /* Bot√µes ligeiramente maiores para toque */
                font-size: 1rem;
            }

            /* Ajuste crucial para os bot√µes de a√ß√£o */
            .question-actions {
                flex-direction: column; /* Empilha os bot√µes */
                align-items: stretch; /* Estica para largura total */
            }

            .next-btn, .skip-btn {
                float: none; /* Remove o float */
                width: 100%; /* Largura total */
                margin-left: 0;
                margin-top: 10px;
                box-sizing: border-box; /* Garante que o padding n√£o quebre o layout */
            }
            
            .check-btn {
                float: none;
                width: 100%;
                margin-top: 10px;
                box-sizing: border-box;
            }

            /* Ajusta os bot√µes de performance e dica */
            #performance-btn, #summary-button, #hint-button {
                width: 100%;
                margin-top: 10px;
                box-sizing: border-box;
            }
            
            #performance-btn {
                margin-right: 0; /* Remove a margem autom√°tica */
                order: 3; 
            }
            #summary-button {
                order: 2;
            }
            #hint-button {
                order: 1;
            }
            
            /* Bot√µes na tela de resultado */
            .results-actions {
                flex-direction: column; /* Empilha */
                gap: 10px;
            }
            
            .results-actions .btn, .results-actions .send-report-btn, .results-actions .restart-btn, .results-actions .share-btn {
                width: 100%;
                margin: 5px 0; /* Espa√ßamento vertical */
                box-sizing: border-box;
            }

            .audio-play-btn {
                width: 100%; /* Ocupa 100% em telas pequenas */
            }

            /* Ajuste para input de fill-in */
            #fill-in-input {
                width: 100%;
                margin-bottom: 10px;
            }
            
            /* Ajuste para drag-drop em telas pequenas */
            #drop-zone {
                display: block; /* Faz a √°rea de drop ocupar a linha */
                margin: 10px 0;
                min-width: 0; /* Remove a largura m√≠nima */
            }
            .drag-options-wrapper {
                margin-top: 15px;
            }
            .drag-option {
                display: block; /* Op√ß√µes de arrastar ficam uma por linha */
                margin: 8px 0;
            }
        }
        /* *** FIM DOS AJUSTES PARA CELULAR *** */
        
    </style>
</head>
<body>

    <div class="container">
        <div id="intro-card" class="intro-card">
            <h1>English Grammar Quiz</h1>
            <h2>ADVERBIAL CLAUSES</h2>
            
            <p id="personalized-welcome" style="font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: none; color: #dc3545;">Seja bem-vindo(a) e boa sorte!</p>

            <p id="quiz-description">Por favor, insira seu c√≥digo de acesso para iniciar o teste. Ele tem 50 quest√µes. Voc√™ tem tentativas <span id="intro-attempts-left">ilimitadas</span> para fazer este teste.</p>
            <input type="text" id="student-code" placeholder="Your Access Code!">
            <div id="start-actions">
                <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
            </div>
        </div>

        <div id="quiz-card" class="question-card">
            <div id="progress-bar-container" class="progress-bar-container">
                <div id="progress-bar" class="progress-bar">0%</div>
            </div>
            <div class="question-header">
                <span class="question-counter"><span id="current-question-num">1</span> de 50</span>
                <span class="attempts-counter" style="display: none;">Tentativas restantes: <span id="attempts-left">Ilimitadas</span></span>
            </div>
            
            <div id="audio-play-container"></div>
            
            <div id="audio-container" class="audio-container"></div>

            <div class="question-text-wrapper">
                <div id="question-text" class="question-text"></div>
                <button id="translate-button" class="translate-btn" title="Traduzir Quest√£o">üåê</button>
            </div>
            <div id="translation-display" class="translation-text"></div>

            <div id="options-list" class="options-list"></div>
            <div id="justification-container"></div>
            <div id="hint-container" style="margin-top: 15px;">
                <button id="hint-button" class="btn hint-btn">Dica</button>
                <div id="hint-text" class="hint-text"></div>
                <div id="summary-text" class="hint-text" style="border-left-color: #28a745;"></div>
            </div>
            <div class="question-actions">
                 <button id="performance-btn" class="btn performance-btn">DESEMPENHO</button>
                <button id="summary-button" class="start-btn" style="background-color: #28a745; display: none;">Resumo</button>
                <button id="skip-button" class="btn skip-btn">Pular Quest√£o</button>
                <button id="next-button" class="btn next-btn">Pr√≥xima Quest√£o</button>
                <div id="performance-display" class="performance-display" style="display: none; width: 100%; flex-basis: 100%; margin-top: 10px;"></div>
            </div>
        </div>

        <div id="results-card" class="results-card">
            <h1>Relat√≥rio Final</h1>
            <p><strong>Nome:</strong> <span id="report-student-name"></span></p>
            <p><strong>C√≥digo de Acesso:</strong> <span id="report-student-code"></span></p>
            <p><strong>Pontua√ß√£o:</strong> <span id="score-display" class="score-display"></span></p>
            <p><strong>Percentual de Acerto:</strong> <span id="percentage-display"></span></p>
            <p><strong>Classifica√ß√£o:</strong> <span id="classification-display"></span></p>
            
            <div class="results-actions">
                <a id="send-report-link" class="send-report-btn" href="#" target="_blank">Enviar Relat√≥rio ao Professor</a>
                <button class="restart-btn" onclick="quizApp.restartQuiz()">Reiniciar Teste</button>
                <a id="share-whatsapp" class="share-btn" href="#" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp"> Compartilhar
                </a>
                <button class="btn save-report-btn" onclick="quizApp.saveReport()">Salvar Relat√≥rio</button>
                
                <button class="btn" style="background-color: #007bff; color: white;" onclick="quizApp.printReport()">Imprimir Relat√≥rio Detalhado</button>
                <button class="btn" style="background-color: #ffc107; color: #333;" onclick="quizApp.printPersonalReport()">Imprimir Resumo Pessoal</button>
            </div>
            
            <div id="full-report-container" class="full-report-list" style="display: none;"></div>
            <div id="personal-report-container" class="full-report-list" style="display: none; border-top: 2px solid #ffc107; margin-top: 20px;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <script>
        const quizApp = {
            APP_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwtDAlCCBcc3cN3pHX5YTvCZBsYTH--UJbeaczv64av_vIkybVIaEs-nTLKM2ssHND2/exec',
            currentQuestionIndex: 0,
            score: 0,
            userAnswers: {},
            validatedStudentName: '',
            validatedStudentCode: '',
            totalAttempts: "Ilimitadas",
            skippedQuestions: [],
            currentSkippedIndex: 0,
            shuffledQuestions: [],
            hintLevel: 0, 
            
            elements: {
                studentCodeInput: document.getElementById('student-code'),
                introCard: document.getElementById('intro-card'),
                quizCard: document.getElementById('quiz-card'),
                resultsCard: document.getElementById('results-card'),
                questionText: document.getElementById('question-text'),
                optionsList: document.getElementById('options-list'),
                justificationContainer: document.getElementById('justification-container'),
                nextButton: document.getElementById('next-button'),
                skipButton: document.getElementById('skip-button'),
                hintButton: document.getElementById('hint-button'),
                hintText: document.getElementById('hint-text'),
                attemptsLeftSpan: document.getElementById('attempts-left'),
                currentQuestionNumSpan: document.getElementById('current-question-num'),
                scoreDisplay: document.getElementById('score-display'),
                percentageDisplay: document.getElementById('percentage-display'),
                classificationDisplay: document.getElementById('classification-display'),
                reportStudentName: document.getElementById('report-student-name'),
                reportStudentCode: document.getElementById('report-student-code'),
                sendReportLink: document.getElementById('send-report-link'),
                introAttemptsLeftSpan: document.getElementById('intro-attempts-left'),
                fullReportContainer: document.getElementById('full-report-container'),
                shareWhatsappLink: document.getElementById('share-whatsapp'),
                personalizedWelcome: document.getElementById('personalized-welcome'),
                startActionsDiv: document.getElementById('start-actions'),
                quizDescription: document.getElementById('quiz-description'),
                summaryButton: document.getElementById('summary-button'),
                summaryText: document.getElementById('summary-text'),
                performanceButton: document.getElementById('performance-btn'),
                performanceDisplay: document.getElementById('performance-display'),
                progressBar: document.getElementById('progress-bar'),
                translateButton: document.getElementById('translate-button'),
                translationDisplay: document.getElementById('translation-display'),
                personalReportContainer: document.getElementById('personal-report-container'),
                audioContainer: document.getElementById('audio-container'),
                audioPlayContainer: document.getElementById('audio-play-container') 
            },

            studentData: {
                "001AB": "ELMA", "002CD": "GUSTAVO", "003EF": "PIETRA", "004GH": "GEOVANNA", "005IJ": "LEOZINHO", "006KL": "MARIANA", "007MN": "NICOLAS", "008OP": "YAGO", "009QR": "CAIO", "010ST": "GIH", "011UV": "LUCAS RESENDE", "012WX": "BRUNA", "013YZ": "DIMI", "014AB": "FABR√çCIO", "015CD": "MIGUEL", "016EF": "YAGO", "017GH": "ANDR√âIA", "018IJ": "KAU√É", "019KL": "PABLO", "020MN": "SURY", "021OP": "TAIN√Å", "022QR": "YASMIN", "023ST": "M√ÅRCIA", "024UV": "RICK", "025WX": "ROSA", "026YZ": "F√ÅTIMA", "027AB": "LUCA", "028CD": "ALEX", "029EF": "D√âBORA", "030GH": "GIOVANNA", "031IJ": "P√ÇMELA", "032KL": "YASMIN", "033MN": "ADRIANO", "034OP": "ARTHUR", "035QR": "YASMIN", "036ST": "DAVI", "037UV": "DEREK", "038WX": "PEDRINHO", "039YZ": "DENILSON", "040AB": "EDSON", "041CD": "AL√çCIA", "042EF": "CAROLINA", "043GH": "ELSON", "044IJ": "LET√çCIA", "045KL": "DIEGO", "046MN": "GABI", "047OP": "KIM", "048QR": "LANA", "049ST": "MANU", "050UV": "SABRINA", "051WX": "BRUNA", "052YZ": "DIMI", "053AB": "FABR√çCIO", "054CD": "MIGUEL", "055EF": "YAGO", "056GH": "ANDR√âIA", "057IJ": "KAU√É", "058KL": "PABLO", "059MN": "SURY", "060OP": "TAIN√Å", "061QR": "YASMIN", "062ST": "M√ÅRCIA", "063UV": "RICK", "064WX": "ROSA", "065YZ": "F√ÅTIMA", "066AB": "LUCA", "067CD": "ALEX", "JR123": "J√öNIOR", "068EF": "D√âBORA", "069GH": "GIOVANNA", "070IJ": "P√ÇMELA", "071KL": "YASMIN", "072MN": "ADRIANO", "073OP": "ARTHUR", "074QR": "YASMIN", "075ST": "DAVI", "076UV": "DEREK", "077WX": "PEDRINHO", "078YZ": "DENILSON", "079AB": "EDSON", "080CD": "AL√çCIA", "081EF": "CAROLINA", "082GH": "ELSON", "083IJ": "LET√çCIA", "084KL": "DIEGO", "085MN": "GABI", "086OP": "KIM", "087QR": "LANA", "088ST": "MANU", "089UV": "SABRINA", "090WX": "DIMI", "101QR": "ANA CLARA", "102ST": "JOAQUIM", "091YZ": "FABR√çCIO", "092AB": "MIGUEL", "093CD": "YAGO", "094EF": "ANDR√âIA", "095GH": "KAU√É", "096IJ": "PABLO", "097KL": "SURY", "098MN": "TAIN√Å", "099OP": "YASMIN", "100QR": "M√ÅRCIA", "0101ST": "MONIQUE", "0102UV": "VICTOR"
            },
            
            summaries: {
                "Time": "As conjun√ß√µes de tempo (when, while, after, before, since, until, as soon as) indicam QUANDO uma a√ß√£o acontece.", "Cause / Reason": "As conjun√ß√µes de causa (because, since, as) explicam o PORQU√ä de uma a√ß√£o acontecer.", "Condition": "As conjun√ß√µes de condi√ß√£o (if, unless, as long as) apresentam as circunst√¢ncias necess√°rias para que uma a√ß√£o aconte√ßa.", "Concession / Contrast": "As conjun√ß√µes de concess√£o (although, though, even though, while) introduzem uma ideia que contrasta com a ora√ß√£o principal.", "Purpose": "As conjun√ß√µes de prop√≥sito (so that, in order that) indicam a FINALIDADE ou o objetivo de uma a√ß√£o.", "Place": "As conjun√ß√µes de lugar (where, wherever) mostram ONDE uma a√ß√£o ocorre.", "Manner": "As conjun√ß√µes de modo (as, as if, as though) descrevem a MANEIRA como uma a√ß√£o √© realizada.", "Result": "As estruturas de resultado (so...that, such...that) indicam a CONSEQU√äNCIA de uma a√ß√£o ou qualidade.",
                "Listening": "Preste aten√ß√£o ao contexto geral, √†s palavras-chave e √† entona√ß√£o para entender a ideia principal do √°udio."
            },

            questions: [
                // Quest√µes 1-20 (inalteradas)
                { type: 'mcq', question: "1. He was watching TV ______ the phone rang.", topic: "Time", hint: "A conjun√ß√£o deve indicar o momento exato em que a segunda a√ß√£o interrompeu a primeira.", options: [ { "text": "when", "isCorrect": true, "rationale": "Indica o ponto no tempo." }, { "text": "although", "isCorrect": false, "rationale": "Expressa contraste." }, { "text": "because", "isCorrect": false, "rationale": "Explica uma raz√£o." }, { "text": "so that", "isCorrect": false, "rationale": "Indica um prop√≥sito." } ] },
                { type: 'mcq', question: "2. We stayed inside ______ it was raining heavily.", topic: "Cause / Reason", hint: "Qual palavra explica o motivo?", options: [ { "text": "because", "isCorrect": true, "rationale": "Introduz a raz√£o." }, { "text": "if", "isCorrect": false, "rationale": "Introduz uma condi√ß√£o." }, { "text": "until", "isCorrect": false, "rationale": "Indica um limite de tempo." }, { "text": "though", "isCorrect": false, "rationale": "Apresenta um contraste." } ] },
                { type: 'mcq', question: "3. You won't pass the exam ______ you study harder.", topic: "Condition", hint: "Significa 'a n√£o ser que'.", options: [ { "text": "unless", "isCorrect": true, "rationale": "Significa 'if not'." }, { "text": "as long as", "isCorrect": false, "rationale": "Indica uma condi√ß√£o positiva." }, { "text": "when", "isCorrect": false, "rationale": "Refere-se a tempo." }, { "text": "because", "isCorrect": false, "rationale": "Explica uma raz√£o." } ] },
                { type: 'mcq', question: "4. ______ he is rich, he is not very happy.", topic: "Concession / Contrast", hint: "Mostra um contraste entre ser rico e n√£o ser feliz.", options: [ { "text": "Although", "isCorrect": true, "rationale": "Introduz uma ideia que contrasta." }, { "text": "Since", "isCorrect": false, "rationale": "Indica uma raz√£o." }, { "text": "If", "isCorrect": false, "rationale": "Apresenta uma condi√ß√£o." }, { "text": "So that", "isCorrect": false, "rationale": "Expressa um prop√≥sito." } ] },
                { type: 'mcq', question: "5. I will call you ______ I arrive at the airport.", topic: "Time", hint: "A a√ß√£o de ligar acontecer√° imediatamente ap√≥s a chegada.", options: [ { "text": "as soon as", "isCorrect": true, "rationale": "Enfatiza a imin√™ncia." }, { "text": "while", "isCorrect": false, "rationale": "Indica simultaneidade." }, { "text": "before", "isCorrect": false, "rationale": "Significa 'antes'." }, { "text": "unless", "isCorrect": false, "rationale": "Estabelece uma condi√ß√£o negativa." } ] },
                { type: 'mcq', question: "6. He saved money ______ he could buy a new laptop.", topic: "Purpose", hint: "Expressa o objetivo de economizar dinheiro.", options: [ { "text": "so that", "isCorrect": true, "rationale": "Indica a finalidade." }, { "text": "wherever", "isCorrect": false, "rationale": "Refere-se a lugar." }, { "text": "although", "isCorrect": false, "rationale": "Introduz um contraste." }, { "text": "as if", "isCorrect": false, "rationale": "Descreve uma maneira." } ] },
                { type: 'mcq', question: "7. She looked at him ______ she had never seen him before.", topic: "Manner", hint: "Descreve a maneira como ela olhou.", options: [ { "text": "as if", "isCorrect": true, "rationale": "Compara com algo imagin√°rio." }, { "text": "even though", "isCorrect": false, "rationale": "Mostra contraste." }, { "text": "in order that", "isCorrect": false, "rationale": "Explica um prop√≥sito." }, { "text": "since", "isCorrect": false, "rationale": "D√° uma raz√£o." } ] },
                { type: 'mcq', question: "8. Please, finish your dinner ______ you watch TV.", topic: "Time", hint: "Uma a√ß√£o deve ser conclu√≠da antes da outra.", options: [ { "text": "before", "isCorrect": true, "rationale": "Estabelece a sequ√™ncia correta." }, { "text": "after", "isCorrect": false, "rationale": "Inverteria a ordem." }, { "text": "while", "isCorrect": false, "rationale": "Sugere simultaneidade." }, { "text": "as", "isCorrect": false, "rationale": "Tamb√©m sugere simultaneidade." } ] },
                { type: 'mcq', question: "9. You can sit ______ you like.", topic: "Place", hint: "Indica um lugar de livre escolha.", options: [ { "text": "wherever", "isCorrect": true, "rationale": "Significa 'em qualquer lugar que'." }, { "text": "so that", "isCorrect": false, "rationale": "Indica prop√≥sito." }, { "text": "unless", "isCorrect": false, "rationale": "Indica condi√ß√£o." }, { "text": "when", "isCorrect": false, "rationale": "Indica tempo." } ] },
                { type: 'mcq', question: "10. The coffee was ______ hot ______ I couldn't drink it.", topic: "Result", hint: "Expressa uma causa e sua consequ√™ncia.", options: [ { "text": "so / that", "isCorrect": true, "rationale": "Estrutura 'so + adjetivo + that'." }, { "text": "such / that", "isCorrect": false, "rationale": "'Such' √© usado com substantivos." }, { "text": "very / and", "isCorrect": false, "rationale": "N√£o conecta causa e resultado." }, { "text": "as / as", "isCorrect": false, "rationale": "Usada para compara√ß√µes." } ] },
                { type: 'mcq', question: "11. ______ I was tired, I went to the party.", topic: "Concession / Contrast", hint: "Ir √† festa contrasta com estar cansado.", options: [ { "text": "Even though", "isCorrect": true, "rationale": "Enfatiza o contraste." }, { "text": "Because", "isCorrect": false, "rationale": "Indicaria o motivo." }, { "text": "As soon as", "isCorrect": false, "rationale": "Refere-se a tempo." }, { "text": "If", "isCorrect": false, "rationale": "Apresenta uma condi√ß√£o." } ] },
                { type: 'mcq', question: "12. I won't leave the house ______ the rain stops.", topic: "Time", hint: "A a√ß√£o de sair s√≥ acontecer√° depois.", options: [ { "text": "until", "isCorrect": true, "rationale": "Indica que a a√ß√£o continuar√° at√© um ponto." }, { "text": "since", "isCorrect": false, "rationale": "Indica uma raz√£o." }, { "text": "while", "isCorrect": false, "rationale": "Sugere simultaneidade." }, { "text": "where", "isCorrect": false, "rationale": "Refere-se a lugar." } ] },
                { type: 'mcq', question: "13. He has to work on weekends ______ he needs to pay his bills.", topic: "Cause / Reason", hint: "Explica por que ele precisa trabalhar.", options: [ { "text": "as", "isCorrect": true, "rationale": "Funciona como 'because'." }, { "text": "unless", "isCorrect": false, "rationale": "Apresenta uma condi√ß√£o negativa." }, { "text": "although", "isCorrect": false, "rationale": "Introduz um contraste." }, { "text": "so that", "isCorrect": false, "rationale": "Indica prop√≥sito." } ] },
                { type: 'mcq', question: "14. You can borrow my car ______ you promise to be careful.", topic: "Condition", hint: "A permiss√£o depende de uma promessa.", options: [ { "text": "as long as", "isCorrect": true, "rationale": "Estabelece uma condi√ß√£o ('contanto que')." }, { "text": "even if", "isCorrect": false, "rationale": "Significa 'mesmo se'." }, { "text": "until", "isCorrect": false, "rationale": "Refere-se a tempo." }, { "text": "because", "isCorrect": false, "rationale": "Explica uma raz√£o." } ] },
                { type: 'mcq', question: "15. My brother likes action movies, ______ I prefer comedies.", topic: "Concession / Contrast", hint: "Contraste direto entre duas prefer√™ncias.", options: [ { "text": "whereas", "isCorrect": true, "rationale": "Compara diretamente duas ideias contrastantes." }, { "text": "provided that", "isCorrect": false, "rationale": "Estabelece uma condi√ß√£o." }, { "text": "since", "isCorrect": false, "rationale": "Indica uma raz√£o." }, { "text": "as if", "isCorrect": false, "rationale": "Compara com algo imagin√°rio." } ] },
                { type: 'mcq', question: "16. Turn off the lights ______ you leave the room.", topic: "Time", hint: "A a√ß√£o deve acontecer no momento de sair.", options: [ { "text": "when", "isCorrect": true, "rationale": "Indica o momento de sair." }, { "text": "although", "isCorrect": false, "rationale": "Expressa contraste." }, { "text": "wherever", "isCorrect": false, "rationale": "Refere-se a lugar." }, { "text": "unless", "isCorrect": false, "rationale": "Apresenta uma condi√ß√£o." } ] },
                { type: 'mcq', question: "17. We should leave early ______ we can avoid the traffic.", topic: "Purpose", hint: "Evitar o tr√¢nsito √© o objetivo.", options: [ { "text": "so that", "isCorrect": true, "rationale": "Explica o prop√≥sito." }, { "text": "as long as", "isCorrect": false, "rationale": "Estabelece uma condi√ß√£o." }, { "text": "even though", "isCorrect": false, "rationale": "Introduz um contraste." }, { "text": "before", "isCorrect": false, "rationale": "Indica tempo." } ] },
                { type: 'mcq', question: "18. He drives ______ he is a professional race car driver.", topic: "Manner", hint: "Compara o modo como ele dirige.", options: [ { "text": "as though", "isCorrect": true, "rationale": "Compara com uma situa√ß√£o hipot√©tica." }, { "text": "because", "isCorrect": false, "rationale": "Daria a entender que ele √© piloto." }, { "text": "until", "isCorrect": false, "rationale": "Refere-se a tempo." }, { "text": "if", "isCorrect": false, "rationale": "Estabelece uma condi√ß√£o." } ] },
                { type: 'mcq', question: "19. I will stay here ______ you get back.", topic: "Time", hint: "Esperar por todo o per√≠odo at√© o retorno.", options: [ { "text": "until", "isCorrect": true, "rationale": "Indica que a a√ß√£o continuar√° at√© a volta." }, { "text": "while", "isCorrect": false, "rationale": "Significa 'durante'." }, { "text": "where", "isCorrect": false, "rationale": "Refere-se a lugar." }, { "text": "unless", "isCorrect": false, "rationale": "Refere-se a condi√ß√£o." } ] },
                { type: 'mcq', question: "20. She got a visa ______ she could travel to the USA.", topic: "Purpose", hint: "Viajar era o objetivo de conseguir o visto.", options: [ { "text": "in order that", "isCorrect": true, "rationale": "√â uma maneira mais formal de 'so that'." }, { "text": "as if", "isCorrect": false, "rationale": "Compara a maneira." }, { "text": "even though", "isCorrect": false, "rationale": "Introduz um contraste." }, { "text": "since", "isCorrect": false, "rationale": "Indica uma raz√£o." } ] },
                
                // Quest√µes 21-30 (Fill-in) - Agora com hintOptions
                { type: 'fill-in', question: "21. It was ______ an interesting book that I read it in one day.", topic: "Result", hint: "Use a palavra que precede 'a/an' em estruturas de resultado com substantivos.", hintOptions: ["such", "so", "very", "too"], answer: ["such"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> A estrutura 'such a/an + ... + that' √© usada com substantivos para indicar resultado." },
                { type: 'fill-in', question: "22. The alarm went off ______ I was sleeping.", topic: "Time", hint: "As duas a√ß√µes estavam acontecendo ao mesmo tempo.", hintOptions: ["while", "as", "before", "until"], answer: ["while", "as"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'While' ou 'as' indicam que uma a√ß√£o aconteceu durante o progresso de outra." },
                { type: 'fill-in', question: "23. ______ he didn't have much experience, he got the job.", topic: "Concession / Contrast", hint: "Use uma palavra sin√¥nima de 'although'.", hintOptions: ["though", "because", "if", "unless"], answer: ["though"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Though' funciona como 'although', introduzindo um contraste." },
                { type: 'fill-in', question: "24. We can go for a walk ______ it doesn't rain.", topic: "Condition", hint: "Significa 'contanto que' ou 'com a condi√ß√£o de que'.", hintOptions: ["provided that", "unless", "in case", "whether"], answer: ["provided that", "providing that", "as long as"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Provided that' (ou 'as long as') estabelece a condi√ß√£o necess√°ria para a caminhada." },
                { type: 'fill-in', question: "25. He will go ______ you go or not.", topic: "Concession / Contrast", hint: "A a√ß√£o dele acontecer√° independentemente da sua decis√£o.", hintOptions: ["whether", "if", "that", "which"], answer: ["whether"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Whether' introduz alternativas, indicando que a a√ß√£o principal n√£o depende delas." },
                { type: 'fill-in', question: "26. Let's meet ______ the cafe is located.", topic: "Place", hint: "A ora√ß√£o deve especificar o local do encontro.", hintOptions: ["where", "when", "which", "that"], answer: ["where"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Where' introduz uma cl√°usula que especifica uma localiza√ß√£o." },
                { type: 'fill-in', question: "27. She has been much happier ______ she changed jobs.", topic: "Time", hint: "A felicidade dela come√ßou em um ponto no passado e continua.", hintOptions: ["since", "until", "after", "while"], answer: ["since"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Since' indica o ponto de partida de um estado que continua at√© o presente." },
                { type: 'fill-in', question: "28. He talks to the dog ______ it understands every word.", topic: "Manner", hint: "A maneira como ele fala √© comparada a uma situa√ß√£o irreal.", hintOptions: ["as though", "even though", "so that", "because"], answer: ["as though", "as if"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'As though' ou 'as if' s√£o usadas para fazer uma compara√ß√£o com uma situa√ß√£o hipot√©tica." },
                { type: 'fill-in', question: "29. ______ the storm was over, we went outside to check the damage.", topic: "Time", hint: "A a√ß√£o de sair aconteceu depois do fim da tempestade.", hintOptions: ["after", "before", "while", "until"], answer: ["after"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'After' indica que a segunda a√ß√£o ocorreu em sequ√™ncia √† primeira." },
                { type: 'fill-in', question: "30. ______ you're here, you might as well help me.", topic: "Cause / Reason", hint: "Significa 'j√° que' a pessoa est√° aqui.", hintOptions: ["since", "if", "although", "unless"], answer: ["since", "as"], rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Since' ou 'as' s√£o usadas aqui com o sentido de 'j√° que', apresentando a raz√£o." },
                
                // Quest√µes 31-50 (inalteradas)
                { type: 'drag-drop', question: "31. I will help you ______ I'm not too busy.", topic: "Condition", hint: "A ajuda est√° condicionada √† disponibilidade de tempo.", options: ["provided that", "unless", "wherever"], answer: "provided that", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Provided that' estabelece a condi√ß√£o ('contanto que') para a ajuda." },
                { type: 'drag-drop', question: "32. The children played outside ______ it started to get dark.", topic: "Time", hint: "A brincadeira continuou at√© um certo limite de tempo.", options: ["until", "since", "while"], answer: "until", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Until' indica que a a√ß√£o durou at√© o momento em que come√ßou a escurecer." },
                { type: 'drag-drop', question: "33. ______ I admit he is a skilled player, I don't think he is a good team captain.", topic: "Concession / Contrast", hint: "Reconhece uma qualidade mas apresenta um ponto contr√°rio.", options: ["While", "As", "If"], answer: "While", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'While' pode ser usada no in√≠cio com o sentido de 'embora'." },
                { type: 'drag-drop', question: "34. Take your umbrella ______ it rains later.", topic: "Condition", hint: "Expressa uma precau√ß√£o para uma possibilidade futura.", options: ["in case", "as long as", "so that"], answer: "in case", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'In case' √© usada para falar de precau√ß√µes que tomamos." },
                { type: 'drag-drop', question: "35. He acted exactly ______ his father told him to.", topic: "Manner", hint: "Descreve a maneira como ele agiu, seguindo instru√ß√µes.", options: ["as", "like", "because"], answer: "as", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'As' √© usada para indicar que algo foi feito da maneira que foi instru√≠do." },
                { type: 'drag-drop', question: "36. The meeting was canceled ______ the manager was sick.", topic: "Cause / Reason", hint: "A doen√ßa do gerente √© o motivo do cancelamento.", options: ["since", "unless", "although"], answer: "since", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Since' funciona como 'because', explicando a raz√£o." },
                { type: 'drag-drop', question: "37. He won't get any dessert ______ he eats his vegetables.", topic: "Condition", hint: "Comer os vegetais √© Œ∑ condi√ß√£o necess√°ria.", options: ["unless", "if", "while"], answer: "unless", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Unless' j√° cont√©m a ideia negativa ('se n√£o')." },
                { type: 'drag-drop', question: "38. The movie starts at 8 PM, so we should leave ______ 7:30 PM.", topic: "Time", hint: "A conjun√ß√£o deve indicar o limite de tempo para a partida.", options: ["before", "after", "once"], answer: "before", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Before' indica que a a√ß√£o deve acontecer antes do hor√°rio." },
                { type: 'drag-drop', question: "39. ______ you finish your work, you can go home.", topic: "Time", hint: "A permiss√£o √© dada imediatamente ap√≥s a conclus√£o.", options: ["Once", "While", "Until"], answer: "Once", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Once' significa 'assim que' ou 'uma vez que'." },
                { type: 'drag-drop', question: "40. I'll be happy to help ______ you need me.", topic: "Time", hint: "A ajuda est√° dispon√≠vel em qualquer momento de necessidade.", options: ["whenever", "wherever", "whatever"], answer: "whenever", rationale: "<strong>A RESPOSTA CORRETA √â:</strong> 'Whenever' significa 'a qualquer momento que'." },
                { type: 'tf', question: "41. A ora√ß√£o 'because it was cold' em 'I wore a coat because it was cold' √© uma ora√ß√£o adverbial de causa.", topic: "Cause / Reason", hint: "A ora√ß√£o explica o 'porqu√™' da a√ß√£o principal.", options: [ { "text": "Verdadeiro", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'Because' introduz a raz√£o ou a causa para a a√ß√£o de usar um casaco." }, { "text": "Falso", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> A ora√ß√£o responde √† pergunta 'Por que eu usei um casaco?', indicando a causa." } ] },
                { type: 'tf', question: "42. A conjun√ß√£o 'unless' introduz uma ora√ß√£o adverbial de prop√≥sito.", topic: "Condition", hint: "Lembre-se do que 'unless' significa. √â o mesmo que 'if... not'.", options: [ { "text": "Verdadeiro", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'Unless' expressa uma condi√ß√£o negativa, n√£o um prop√≥sito. 'So that' expressaria prop√≥sito." }, { "text": "Falso", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'Unless' introduz uma condi√ß√£o ('a n√£o ser que'), n√£o um prop√≥sito." } ] },
                { type: 'tf', question: "43. Na frase 'He sings as if he were a professional', a ora√ß√£o 'as if he were a professional' √© adverbial de modo.", topic: "Manner", hint: "Esta ora√ß√£o descreve 'como' ou 'de que maneira' ele canta.", options: [ { "text": "Verdadeiro", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'As if' √© usado para descrever a maneira como a a√ß√£o √© realizada, geralmente atrav√©s de uma compara√ß√£o." }, { "text": "Falso", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> A ora√ß√£o foca na maneira da a√ß√£o, que √© a defini√ß√£o de uma ora√ß√£o de modo (manner)." } ] },
                { type: 'tf', question: "44. 'Although' e 'because' s√£o intercambi√°veis, pois ambas introduzem ora√ß√µes de contraste.", topic: "Concession / Contrast", hint: "Pense no significado de cada palavra. Uma expressa contraste e a outra, raz√£o.", options: [ { "text": "Verdadeiro", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'Although' introduz contraste, enquanto 'because' introduz uma raz√£o ou causa." }, { "text": "Falso", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> Elas t√™m fun√ß√µes gramaticais muito diferentes e n√£o s√£o intercambi√°veis." } ] },
                { type: 'tf', question: "45. A ora√ß√£o 'wherever you go' em 'I will follow you wherever you go' √© uma ora√ß√£o adverbial de tempo.", topic: "Place", hint: "'Wherever' responde √† pergunta 'onde?' e n√£o 'quando?'.", options: [ { "text": "Verdadeiro", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'Wherever' significa 'em qualquer lugar que', indicando lugar, n√£o tempo. 'Whenever' indicaria tempo." }, { "text": "Falso", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'Wherever' introduz uma ora√ß√£o adverbial de lugar (place)." } ] },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://archive.org/download/audio_pausa_longa_2/audio_pausa_longa_1.mp3', 
                  question: '46. Ou√ßa o √°udio e complete a frase escolhendo a alternativa correta.',
                  hint: "<strong>DICA 1:</strong> A frase √©: 'He saved money ______ he could buy a new laptop.'",
                  hint_2: "<strong>DICA 2:</strong> A palavra correta indica o 'prop√≥sito' de economizar dinheiro.",
                  topic: "Purpose", 
                  options: [ 
                    { "text": "so that", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'so that' (para que) indica a finalidade ou o prop√≥sito de economizar dinheiro." }, 
                    { "text": "wherever", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'wherever' (onde quer que) refere-se a lugar, n√£o prop√≥sito." },
                    { "text": "although", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'although' (embora) indica um contraste, o que n√£o faz sentido aqui." },
                    { "text": "as if", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'as if' (como se) descreve a maneira, n√£o o prop√≥sito." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://archive.org/download/audio_pausa_longa_2/audio_pausa_longa_2.mp3', 
                  question: '47. Ou√ßa o √°udio e complete a frase escolhendo a alternativa correta.',
                  hint: "<strong>DICA 1:</strong> A frase √©: 'You won't pass the exam ______ you study harder.'",
                  hint_2: "<strong>DICA 2:</strong> A palavra correta significa 'a n√£o ser que' ou 'se n√£o'.",
                  topic: "Condition", 
                  options: [ 
                    { "text": "unless", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'Unless' (a n√£o ser que) introduz a condi√ß√£o negativa necess√°ria (if you don't study...)." }, 
                    { "text": "as long as", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'as long as' (contanto que) √© usado para condi√ß√µes positivas ('You *will* pass as long as you study')." },
                    { "text": "when", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'when' (quando) refere-se a tempo, n√£o condi√ß√£o." },
                    { "text": "because", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'because' (porque) daria a raz√£o, o que n√£o faz sentido com 'won\\'t pass'." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://archive.org/download/audio_pausa_longa_2/audio_pausa_longa_3.mp3', 
                  question: '48. Ou√ßa o √°udio e complete a frase escolhendo a alternativa correta.',
                  hint: "<strong>DICA 1:</strong> A frase √©: '______ I was tired, I went to the party.'",
                  hint_2: "<strong>DICA 2:</strong> A palavra correta mostra um 'contraste' (ir √† festa *apesar* de estar cansado).",
                  topic: "Concession / Contrast", 
                  options: [ 
                    { "text": "Even though", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'Even though' (Embora/Mesmo que) mostra o contraste entre estar cansado e (mesmo assim) ir √† festa." }, 
                    { "text": "Because", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'Because' (Porque) daria a raz√£o ('Eu fui √† festa *porque* estava cansado'), o que √© o oposto." },
                    { "text": "As soon as", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'As soon as' (Assim que) refere-se a tempo, n√£o contraste." },
                    { "text": "If", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'If' (Se) criaria uma condi√ß√£o, o que n√£o se aplica." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://archive.org/download/audio_pausa_longa_2/audio_pausa_longa_4.mp3', 
                  question: '49. Ou√ßa o √°udio e complete a frase escolhendo a alternativa correta.',
                  hint: "<strong>DICA 1:</strong> A frase √©: 'We should leave early ______ we can avoid the traffic.'",
                  hint_2: "<strong>DICA 2:</strong> A palavra correta indica a 'finalidade' (o objetivo) de sair cedo.",
                  topic: "Purpose", 
                  options: [ 
                    { "text": "so that", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'so that' (para que) explica o prop√≥sito ou a finalidade de sair cedo." }, 
                    { "text": "as long as", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'as long as' (contanto que) criaria uma condi√ß√£o, n√£o um prop√≥sito." },
                    { "text": "even though", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'even though' (embora) mostraria um contraste." },
                    { "text": "before", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'before' (antes) refere-se a tempo." } 
                  ] 
                },
                { 
                  type: 'audio_mcq', 
                  audioSrc: 'https://archive.org/download/audio_pausa_longa_2/audio_pausa_longa_5.mp3', 
                  question: '50. Ou√ßa o √°udio e complete a frase escolhendo a alternativa correta.',
                  hint: "<strong>DICA 1:</strong> A frase √©: 'I will stay here ______ you get back.'",
                  hint_2: "<strong>DICA 2:</strong> A palavra correta indica um limite de 'tempo' (eu vou ficar *at√©* voc√™ voltar).",
                  topic: "Time", 
                  options: [ 
                    { "text": "until", "isCorrect": true, "rationale": "<strong>A RESPOSTA CORRETA √â:</strong> 'Until' (at√© que) indica a dura√ß√£o da a√ß√£o de 'ficar' (ela termina quando voc√™ voltar)." }, 
                    { "text": "while", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'while' (enquanto) implicaria que as a√ß√µes s√£o simult√¢neas, mas a volta ainda n√£o aconteceu." },
                    { "text": "where", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'where' (onde) refere-se a lugar." },
                    { "text": "unless", "isCorrect": false, "rationale": "<strong>INCORRETO:</strong> 'unless' (a n√£o ser que) √© para condi√ß√µes." } 
                  ] 
                }
            ],

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            balanceCorrectAnswers() {
                const mcqQuestions = this.questions.filter(q => q.type === 'mcq' && q.options && q.options.length === 4);
                if (mcqQuestions.length === 0) return;
                
                const numPositions = 4;
                let desiredPositions = [];
                for (let i = 0; i < mcqQuestions.length; i++) {
                    desiredPositions.push(i % numPositions);
                }
                this.shuffleArray(desiredPositions);
                
                let mcqCounter = 0;
                this.questions.forEach((q) => {
                    if (q.type === 'mcq' && q.options && q.options.length === 4) {
                        this.shuffleArray(q.options);
                        const correctOption = q.options.find(opt => opt.isCorrect);
                        if (!correctOption) return;
                        const targetIndex = desiredPositions[mcqCounter];
                        if (q.options.indexOf(correctOption) !== targetIndex) {
                            const currentIndex = q.options.indexOf(correctOption);
                            [q.options[currentIndex], q.options[targetIndex]] = [q.options[targetIndex], q.options[currentIndex]];
                        }
                        mcqCounter++;
                    }
                });
            },
            
            updateProgressBar() {
                const totalQuestions = this.questions.length;
                const answeredCount = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;
                const percentage = totalQuestions > 0 ? Math.round((answeredCount / totalQuestions) * 100) : 0;
                this.elements.progressBar.style.width = percentage + '%';
                this.elements.progressBar.textContent = percentage + '%';
            },

            startQuiz(continueFromSavedState) {
                const studentCode = this.elements.studentCodeInput.value.trim().toUpperCase();
                const correctName = this.studentData[studentCode];
                if (!correctName) {
                    alert("C√≥digo de acesso inv√°lido.");
                    return;
                }
                this.validatedStudentCode = studentCode;
                this.validatedStudentName = correctName;
                if (continueFromSavedState) { 
                    this.loadQuizState(this.validatedStudentCode); 
                } 
                else {
                    this.currentQuestionIndex = 0;
                    this.score = 0;
                    this.userAnswers = {};
                    this.skippedQuestions = [];
                    this.currentSkippedIndex = 0;
		            this.balanceCorrectAnswers();
                    localStorage.removeItem(`quizState_${this.validatedStudentCode}`); 
                    this.shuffledQuestions = this.shuffleArray([...this.questions]);
                }
                this.elements.introCard.style.display = 'none';
                this.elements.quizCard.style.display = 'flex';
                this.displayQuestion();
            },

            displayQuestion() {
                this.updateProgressBar();
                this.elements.performanceDisplay.style.display = 'none';
                this.elements.justificationContainer.innerHTML = '';
                this.elements.hintText.style.display = 'none';
                this.elements.summaryText.style.display = 'none';
                this.elements.summaryButton.style.display = 'none';
                this.elements.nextButton.style.display = 'none';

                this.elements.translationDisplay.style.display = 'none'; 
                this.elements.translateButton.style.display = 'inline-block'; 
                this.elements.translateButton.disabled = false;
                this.elements.translateButton.textContent = 'üåê'; 
                
                this.elements.audioContainer.innerHTML = ''; 
                this.elements.audioPlayContainer.innerHTML = ''; 
                this.elements.questionText.style.display = 'flex'; 

                // *** AJUSTE DE RESET DAS DICAS (CORRETO) ***
                this.hintLevel = 0; // Reseta o n√≠vel da dica para as de √°udio
                this.elements.hintButton.textContent = 'Dica'; // Sempre reseta o texto do bot√£o
                this.elements.hintButton.style.backgroundColor = '#6a0dad'; // Reseta a cor para o roxo original
                this.elements.hintButton.disabled = false; // Sempre re-abilita o bot√£o
                this.elements.hintButton.onclick = () => this.showHint(); 
                // *** FIM DO AJUSTE ***

                let questionToDisplay;
                let currentQuestionNumber;
                let totalAnswered = (this.currentQuestionIndex - this.skippedQuestions.length) + this.currentSkippedIndex;

                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0 && this.currentSkippedIndex < this.skippedQuestions.length) {
                    const skippedIndex = this.skippedQuestions[this.currentSkippedIndex];
                    questionToDisplay = this.questions[skippedIndex]; 
                    currentQuestionNumber = `(Pulada ${this.currentSkippedIndex + 1}/${this.skippedQuestions.length})`
                    this.elements.skipButton.style.display = 'none';
                } else if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    questionToDisplay = this.shuffledQuestions[this.currentQuestionIndex];
                    currentQuestionNumber = totalAnswered + 1;
                    this.elements.skipButton.style.display = 'inline-block';
                } else {
                    this.showResults();
                    return;
                }
                
                this.elements.currentQuestionNumSpan.textContent = currentQuestionNumber;
                
                this.elements.optionsList.innerHTML = '';

                switch (questionToDisplay.type) {
                    case 'fill-in': this.renderFillIn(questionToDisplay); break;
                    case 'drag-drop': this.renderDragDrop(questionToDisplay); break;
                    case 'tf': this.renderMCQ(questionToDisplay); break;
                    case 'audio_mcq': this.renderAudioMCQ(questionToDisplay); break; 
                    case 'mcq': default: this.renderMCQ(questionToDisplay); break;
                }
            },

            renderAudioMCQ(question) {
                this.elements.audioContainer.innerHTML = ''; 
                const audioEl = document.createElement('audio');
                audioEl.src = question.audioSrc;
                audioEl.preload = 'auto'; 
                this.elements.audioContainer.appendChild(audioEl);

                this.elements.audioPlayContainer.innerHTML = ''; 
                const playBtn = document.createElement('button');
                playBtn.className = 'btn audio-play-btn';
                playBtn.textContent = 'Ouvir Quest√£o üéß';
                playBtn.onclick = () => audioEl.play();
                this.elements.audioPlayContainer.appendChild(playBtn);
                
                this.elements.translateButton.style.display = 'none';

                this.renderMCQ(question);
            },

            renderMCQ(question) {
                this.elements.questionText.innerHTML = ''; 
                this.elements.questionText.textContent = question.question;
                question.options.forEach(option => {
                    const li = document.createElement('li');
                    li.className = 'option-item';
                    li.textContent = option.text;
                    li.onclick = () => this.selectOption(li, option);
                    this.elements.optionsList.appendChild(li);
                });
            },

            renderFillIn(question) {
                this.elements.questionText.innerHTML = ''; 
                this.elements.questionText.textContent = question.question;
                const input = document.createElement('input');
                input.id = 'fill-in-input';
                input.placeholder = 'Digite sua resposta...';
                const checkButton = document.createElement('button');
                checkButton.textContent = 'Verificar';
                checkButton.className = 'btn check-btn';
                checkButton.onclick = () => {
                    const userAnswer = input.value.trim().toLowerCase();
                    const isCorrect = question.answer.map(ans => ans.toLowerCase()).includes(userAnswer);
                    this.handleAnswer(isCorrect, question.rationale, input.value.trim(), question.answer[0]);
                    input.disabled = true;
                    checkButton.style.display = 'none';
                    input.classList.add(isCorrect ? 'correct' : 'incorrect');
                };
                this.elements.optionsList.appendChild(input);
                this.elements.optionsList.appendChild(checkButton);
            },

            renderDragDrop(question) {
                const dropZone = document.createElement('span');
                dropZone.id = 'drop-zone';
                dropZone.textContent = 'Arraste aqui';
                const questionTextHTML = question.question.replace('______', dropZone.outerHTML);
                this.elements.questionText.innerHTML = questionTextHTML; 
                const actualDropZone = this.elements.questionText.querySelector('#drop-zone');
                const dragOptionsWrapper = document.createElement('div');
                dragOptionsWrapper.className = 'drag-options-wrapper';
                this.shuffleArray(question.options).forEach(opt => {
                    const optionEl = document.createElement('span');
                    optionEl.textContent = opt;
                    optionEl.className = 'drag-option';
                    optionEl.draggable = true;
                    optionEl.dataset.value = opt;
                    optionEl.ondragstart = (e) => { e.dataTransfer.setData('text/plain', e.target.dataset.value); e.target.classList.add('dragging'); };
                    optionEl.ondragend = (e) => e.target.classList.remove('dragging');
                    dragOptionsWrapper.appendChild(optionEl);
                });
                this.elements.optionsList.appendChild(dragOptionsWrapper);
                actualDropZone.ondragover = (e) => { e.preventDefault(); actualDropZone.classList.add('over'); };
                actualDropZone.ondragleave = () => actualDropZone.classList.remove('over');
                actualDropZone.ondrop = (e) => {
                    e.preventDefault();
                    actualDropZone.classList.remove('over');
                    const droppedValue = e.dataTransfer.getData('text/plain');
                    const isCorrect = (droppedValue.toLowerCase() === question.answer.toLowerCase());
                    this.handleAnswer(isCorrect, question.rationale, droppedValue, question.answer);
                    actualDropZone.textContent = droppedValue;
                    actualDropZone.classList.add(isCorrect ? 'correct' : 'incorrect');
                    this.elements.optionsList.querySelectorAll('.drag-option').forEach(el => { el.draggable = false; el.style.cursor = 'not-allowed'; el.style.opacity = '0.6'; });
                };
            },

            selectOption(selectedElement, selectedOption) {
                this.elements.optionsList.querySelectorAll('.option-item').forEach(option => option.style.pointerEvents = 'none');
                const isCorrect = selectedOption.isCorrect;
                
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }
                
                if (currentQuestion.type === 'tf') {
                    selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
                    this.handleAnswer(isCorrect, isCorrect ? currentQuestion.options.find(o=>o.isCorrect).rationale : currentQuestion.options.find(o=>!o.isCorrect).rationale, selectedOption.text, currentQuestion.options.find(o => o.isCorrect).text);
                } else { 
                    selectedElement.classList.add(isCorrect ? 'correct' : 'incorrect');
                    this.handleAnswer(isCorrect, selectedOption.rationale, selectedOption.text, currentQuestion.options.find(o => o.isCorrect).text);
                }

                if (!isCorrect) {
                    const correctText = currentQuestion.options.find(opt => opt.isCorrect).text;
                    const correctElement = Array.from(this.elements.optionsList.querySelectorAll('.option-item')).find(el => el.textContent === correctText);
                    if (correctElement) correctElement.classList.add('correct');
                }
            },

            handleAnswer(isCorrect, rationale, userAnswer, correctAnswer) {
                if (isCorrect) {
                    this.score++;
                    this.elements.summaryButton.style.display = 'none';
                } else {
                    this.elements.summaryButton.style.display = 'inline-block';
                }
                const justificationElement = document.createElement('div');
                justificationElement.className = 'justification';
                justificationElement.innerHTML = rationale; 
                justificationElement.style.borderLeftColor = isCorrect ? '#28a745' : '#dc3545';
                this.elements.justificationContainer.appendChild(justificationElement);
                
                let originalQuestionIndex;
                let currentQuestion;
                 if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                    originalQuestionIndex = this.skippedQuestions[this.currentSkippedIndex];
                    currentQuestion = this.questions[originalQuestionIndex];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    originalQuestionIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                }
                
                this.userAnswers[originalQuestionIndex] = {
                    question: currentQuestion.question, 
                    userAnswer: userAnswer,
                    isCorrect: isCorrect,
                    correctAnswer: correctAnswer,
                    rationale: rationale,
                    type: currentQuestion.type || 'mcq',
                    topic: currentQuestion.topic || 'Geral' 
                };
                
                this.elements.nextButton.style.display = 'block';
                this.elements.skipButton.style.display = 'none';
                this.saveQuizState();
            },

            showPerformance() {
                const display = this.elements.performanceDisplay;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    const answeredCount = Object.keys(this.userAnswers).length;
                    const incorrectCount = answeredCount - this.score;
                    display.innerHTML = `<strong style="color: #333;">At√© agora:</strong> <span style="color: #28a745;">${this.score} acertos</span> <strong style="color: #333;">e</strong> <span style="color: #dc3545;">${incorrectCount} erros</span><strong style="color: #333;">!</strong>`;
                    display.style.display = 'block';
                    this.elements.hintText.style.display = 'none';
                    this.elements.summaryText.style.display = 'none';
                }
            },
            
            // *** IN√çCIO DA MODIFICA√á√ÉO: showHint() ***
            showHint() {
                const display = this.elements.hintText;
                const button = this.elements.hintButton; 
                let currentQuestion;
                
                if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                // Esconde os outros pain√©is
                this.elements.performanceDisplay.style.display = 'none';
                this.elements.summaryText.style.display = 'none';

                // --- L√ìGICA PARA √ÅUDIO (N√≠veis) ---
                if (currentQuestion.type === 'audio_mcq') {
                    if (this.hintLevel === 0) { // Clique 1: Roxo -> Verde (Dica 1)
                        display.innerHTML = currentQuestion.hint; // MODIFICADO AQUI
                        display.style.display = 'block';
                        button.textContent = 'DICA 2';
                        button.style.backgroundColor = '#28a745'; // Verde
                        this.hintLevel = 1; 
                    } else if (this.hintLevel === 1) { // Clique 2: Verde -> Verde (Dica 1 + 2)
                        display.innerHTML = currentQuestion.hint + '<br><br>' + currentQuestion.hint_2; // MODIFICADO AQUI
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas'; 
                        this.hintLevel = 2; 
                    } else if (this.hintLevel === 2) { // Clique 3: Verde -> Verde (Oculta)
                        display.style.display = 'none';
                        button.textContent = 'Mostrar Dicas';
                        this.hintLevel = 3; 
                    } else if (this.hintLevel === 3) { // Clique 4: Verde -> Verde (Mostra 1 + 2)
                        display.innerHTML = currentQuestion.hint + '<br><br>' + currentQuestion.hint_2; // MODIFICADO AQUI
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas';
                        this.hintLevel = 2; 
                    }
                } 
                // --- NOVA L√ìGICA PARA FILL-IN (N√≠veis) ---
                else if (currentQuestion.type === 'fill-in') {
                     if (this.hintLevel === 0) { // Clique 1: Roxo -> Verde (Dica 1)
                        display.innerHTML = currentQuestion.hint; // Usar innerHTML caso a dica tenha HTML
                        display.style.display = 'block';
                        button.textContent = 'Ver Op√ß√µes';
                        button.style.backgroundColor = '#28a745'; // Verde
                        this.hintLevel = 1; 
                    } else if (this.hintLevel === 1) { // Clique 2: Verde -> Verde (Dica 1 + Op√ß√µes)
                        const hintOptionsText = '<strong>Poss√≠veis respostas:</strong> ' + currentQuestion.hintOptions.join(' / ');
                        display.innerHTML = currentQuestion.hint + '<br><br>' + hintOptionsText;
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas'; 
                        this.hintLevel = 2; 
                    } else if (this.hintLevel === 2) { // Clique 3: Verde -> Verde (Oculta)
                        display.style.display = 'none';
                        button.textContent = 'Mostrar Dicas';
                        this.hintLevel = 3; 
                    } else if (this.hintLevel === 3) { // Clique 4: Verde -> Verde (Mostra 1 + Op√ß√µes)
                        const hintOptionsText = '<strong>Poss√≠veis respostas:</strong> ' + currentQuestion.hintOptions.join(' / ');
                        display.innerHTML = currentQuestion.hint + '<br><br>' + hintOptionsText;
                        display.style.display = 'block';
                        button.textContent = 'Ocultar Dicas';
                        this.hintLevel = 2; 
                    }
                }
                // --- L√ìGICA PADR√ÉO (Toggle Simples) ---
                else {
                    // (para MCQ, TF, Drag-Drop que s√≥ t√™m 1 dica)
                    if (display.style.display === 'block') {
                        display.style.display = 'none';
                    } else {
                        if (currentQuestion && currentQuestion.hint) {
                            display.innerText = currentQuestion.hint;
                            display.style.display = 'block';
                        }
                    }
                }
            },
            // *** FIM DA MODIFICA√á√ÉO: showHint() ***

            showSummary() {
                const display = this.elements.summaryText;
                if (display.style.display === 'block') {
                    display.style.display = 'none';
                } else {
                    let currentQuestion;
                    if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                        currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                    } else {
                        currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    }
                    const questionTopic = currentQuestion.topic;
                    if (questionTopic && this.summaries[questionTopic]) {
                        display.textContent = this.summaries[questionTopic];
                        display.style.display = 'block';
                        this.elements.performanceDisplay.style.display = 'none';
                        this.elements.hintText.style.display = 'none';
                    }
                }
            },

            translateQuestion() {
                const button = this.elements.translateButton;
                const display = this.elements.translationDisplay;
                
                let currentQuestion;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length  && this.skippedQuestions.length > 0) {
                    currentQuestion = this.questions[this.skippedQuestions[this.currentSkippedIndex]];
                } else {
                    currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                }

                if (display.style.display === 'block') {
                    display.style.display = 'none';
                    button.textContent = 'üåê';
                    return;
                }
                
                let textToTranslate;
                if (currentQuestion.type === 'drag-drop') {
                    textToTranslate = currentQuestion.question; 
                } else {
                    textToTranslate = this.elements.questionText.textContent;
                }

                display.textContent = 'Traduzindo...';
                display.style.display = 'block';
                button.disabled = true;

                const langPair = 'en|pt'; 
                const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=${langPair}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.responseData && data.responseData.translatedText) {
                            display.textContent = data.responseData.translatedText;
                        } else {
                            display.textContent = 'Erro ao traduzir. Tente novamente.';
                        }
                        button.disabled = false;
                        button.textContent = 'üôà'; 
                    })
                    .catch(error => {
                        console.error('Translation error:', error);
                        display.textContent = 'N√£o foi poss√≠vel conectar ao servi√ßo de tradu√ß√£o.';
                        button.disabled = false;
                        button.textContent = 'üåê';
                    });
            },

            nextQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    this.currentQuestionIndex++;
                } else {
                    this.currentSkippedIndex++;
                }
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.currentSkippedIndex >= this.skippedQuestions.length) {
                    this.showResults();
                } else {
                    this.displayQuestion();
                }
            },

            skipQuestion() {
                if (this.currentQuestionIndex < this.shuffledQuestions.length) {
                    let currentQuestion = this.shuffledQuestions[this.currentQuestionIndex];
                    const originalIndex = this.questions.findIndex(q => q.question === currentQuestion.question);
                    if (!this.skippedQuestions.includes(originalIndex)) {
                        this.skippedQuestions.push(originalIndex);
                    }
                }
                this.currentQuestionIndex++;
                if (this.currentQuestionIndex >= this.shuffledQuestions.length && this.skippedQuestions.length === 0) {
                    this.showResults();
                } else {
                    this.displayQuestion();
                }
            },

            getClassification(percentage) {
                if (percentage >= 86) return "Excelente!!!"; if (percentage >= 71) return "Muito Bom!!"; if (percentage >= 51) return "Bom!"; if (percentage >= 0) return "Insatisfat√≥rio!"; return "";
            },
            launchConfetti() { confetti({ particleCount: 600, spread: 70, origin: { y: 0.6 } }); },

            showResults() {
                const percentage = Math.round((this.score / this.questions.length) * 100);
                const classificationText = this.getClassification(percentage);

                const reportData = {
                    isCompleted: true, 
                    studentName: this.validatedStudentName,
                    studentCode: this.validatedStudentCode,
                    score: this.score,
                    totalQuestions: this.questions.length,
                    percentage: percentage,
                    classification: classificationText,
                    userAnswers: this.userAnswers,
                    originalQuestions: this.questions 
                };

                this.saveCompletedReport(reportData); 
                this.saveFinalReport(reportData);     

                this.displayReport(reportData);

                const dataForGoogle = { 
                    nome: this.validatedStudentName, 
                    codigo: this.validatedStudentCode, 
                    pontuacao: `${this.score} de ${this.questions.length}`, 
                    percentual: `${percentage}%`, 
                    classificacao: classificationText 
                };
                
                fetch(this.APP_SCRIPT_URL, { method: 'POST', body: JSON.stringify(dataForGoogle), headers: { 'Content-Type': 'application/json' }, mode: 'no-cors' })
                    .then(() => { 
                        this.elements.sendReportLink.textContent = 'Relat√≥rio Enviado!'; 
                        this.elements.sendReportLink.style.backgroundColor = '#ccc'; 
                        this.elements.sendReportLink.onclick = (e) => e.preventDefault(); 
                    })
                    .catch(error => console.error('Erro:', error));
            },

            saveCompletedReport(reportData) {
                if (!reportData.studentCode) return;
                try {
                    localStorage.setItem(`quizState_${reportData.studentCode}`, JSON.stringify(reportData));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
                }
            },

            saveFinalReport(reportData) {
                if (!reportData.studentCode) return;
                try {
                    localStorage.setItem(`quizReport_${reportData.studentCode}`, JSON.stringify(reportData));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o relat√≥rio final permanente:", e);
                }
            },

            displayReport(data) {
                this.elements.quizCard.style.display = 'none';
                this.elements.resultsCard.style.display = 'block';

                this.validatedStudentName = data.studentName;
                this.validatedStudentCode = data.studentCode;
                this.score = data.score;
                this.userAnswers = data.userAnswers;
                this.questions = data.originalQuestions; 

                this.elements.reportStudentName.textContent = data.studentName;
                this.elements.reportStudentCode.textContent = data.studentCode;
                this.elements.scoreDisplay.textContent = `${data.score} de ${data.totalQuestions}`;
                this.elements.percentageDisplay.textContent = `${data.percentage}%`;
                this.elements.classificationDisplay.textContent = data.classification;
                
                if (data.classification === "Excelente!!!") this.launchConfetti();
                
                this.elements.fullReportContainer.innerHTML = this.generateFullReportHtml();
                this.elements.personalReportContainer.innerHTML = this.generatePersonalReportHtml();
                
                const shareMessage = this.generateShareMessage(data.percentage, data.classification);
                this.elements.shareWhatsappLink.href = `https://wa.me/?text=${encodeURIComponent(shareMessage)}`;
            },

            retrieveReport(code) {
                const finalReportJSON = localStorage.getItem(`quizReport_${code}`);
                if (!finalReportJSON) {
                    alert('Erro: Relat√≥rio n√£o encontrado.');
                    return;
                }
                
                try {
                    const state = JSON.parse(finalReportJSON);
                    if (state.isCompleted) {
                        this.elements.introCard.style.display = 'none';
                        this.displayReport(state); 
                        
                        this.elements.sendReportLink.textContent = 'Relat√≥rio J√° Enviado';
                        this.elements.sendReportLink.style.backgroundColor = '#ccc';
                        this.elements.sendReportLink.onclick = (e) => e.preventDefault();
                    } else {
                        alert('O relat√≥rio salvo √© inv√°lido.');
                    }
                } catch (e) {
                    alert('Erro ao carregar relat√≥rio.');
                    localStorage.removeItem(`quizReport_${code}`); 
                }
            },

            getCorrectAnswerForQuestion(question) {
                if (question.type === 'fill-in') {
                    return question.answer[0];
                }
                if (question.type === 'drag-drop') {
                    return question.answer;
                }
                if (question.type === 'mcq' || question.type === 'tf' || question.type === 'audio_mcq') { 
                    const correctOption = question.options.find(o => o.isCorrect);
                    return correctOption ? correctOption.text : 'N/A';
                }
                return 'N/A';
            },

            generateFullReportHtml() {
                let reportHtml = '<h3>Relat√≥rio Detalhado</h3>';
                this.questions.forEach((question, index) => {
                    const answerData = this.userAnswers[index];
                    let questionText = question.question; 
                    questionText = questionText.replace(/______/g, '...'); 
                    
                    if (question.type === 'audio_mcq') {
                        questionText = `${questionText} (Quest√£o de √Åudio: '${question.hint.replace("<strong>DICA 1:</strong> A frase √©: ", "")}')`;
                    }

                    if (answerData) {
                        const itemClass = answerData.isCorrect ? 'correct' : 'incorrect';
                        reportHtml += `
                            <div class="report-question-item">
                                <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                                <p><strong>Sua Resposta:</strong> <span class="option-item-report ${itemClass}">${answerData.userAnswer}</span></p>
                                ${!answerData.isCorrect ? `<p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${answerData.correctAnswer}</span></p>` : ''}
                                <p><em>Justificativa: ${answerData.rationale}</em></p>
                            </div>
                        `;
                    } else {
                        const correctAnswer = this.getCorrectAnswerForQuestion(question);
                        const rationale = question.rationale || (question.options ? (question.options.find(o => o.isCorrect) || {}).rationale : '');
                        reportHtml += `
                            <div class="report-question-item">
                                <p><strong>Quest√£o ${index + 1}:</strong> ${questionText}</p>
                                <p><strong>Sua Resposta:</strong> <span class="option-item-report incorrect">N√£o respondida</span></p>
                                <p><strong>Resposta Correta:</strong> <span class="option-item-report correct">${correctAnswer}</span></p>
                                <p><em>Justificativa: ${rationale}</em></p>
                            </div>
                        `;
                    }
                });
                return reportHtml;
            },
            
            analyzePerformanceByTopic() {
                const topicErrors = {};
                const topicTotals = {};

                this.questions.forEach((question, index) => {
                    const topic = question.topic;
                    if (!topic) return; 
                    if (!topicTotals[topic]) topicTotals[topic] = 0;
                    topicTotals[topic]++;

                    const answerData = this.userAnswers[index];
                    if (!answerData || !answerData.isCorrect) {
                        if (!topicErrors[topic]) topicErrors[topic] = 0;
                        topicErrors[topic]++;
                    }
                });
                
                return { topicErrors, topicTotals };
            },
            
            generatePersonalReportHtml() {
                const analysis = this.analyzePerformanceByTopic();
                let html = '<h3>Relat√≥rio Pessoal de Estudos</h3>';
                
                const topicsToReview = [];
                for (const topic in analysis.topicErrors) {
                    const errors = analysis.topicErrors[topic];
                    if (errors > 0) {
                        const total = analysis.topicTotals[topic];
                        const errorRate = (errors / total) * 100;
                        topicsToReview.push({ topic: topic, errors: errors, total: total, rate: errorRate });
                    }
                }

                topicsToReview.sort((a, b) => b.errors - a.errors);

                if (topicsToReview.length === 0) {
                    html += '<p style="font-weight: bold; color: #28a745;">Parab√©ns! Voc√™ n√£o errou nenhuma quest√£o. N√£o h√° nada para revisar.</p>';
                } else {
                     html += `<p>Aqui est√° seu guia de estudos focado nos t√≥picos que voc√™ precisa revisar, come√ßando pelos mais dif√≠ceis:</p><br>`;
                    topicsToReview.forEach(item => {
                        const summaryText = this.summaries[item.topic] || "N√£o h√° resumo dispon√≠vel para este t√≥pico.";
                        html += `
                            <div class="personal-summary-item">
                                <h4>T√≥pico: ${item.topic}</h4>
                                <p><strong>Seu desempenho:</strong> <span style="color: #dc3545;">${item.errors} de ${item.total} erradas</span> (${item.rate.toFixed(0)}% de erro)</p>
                                <p><strong>Resumo para Revis√£o:</strong><br>${summaryText}</p>
                            </div>
                        `;
                    });
                }

                return html;
            },
            
            printPersonalReport() {
                this.elements.fullReportContainer.style.display = 'none';
                this.elements.personalReportContainer.style.display = 'block';
                window.print();
            },
            
            printReport() { 
                this.elements.personalReportContainer.style.display = 'none';
                this.elements.fullReportContainer.style.display = 'block';
                window.print();
            },
            
            generateShareMessage(percentage, classificationText) {
                return `Acabei de fazer o quiz "ADVERBIAL CLAUSES"! Meu resultado: ${percentage}% (${classificationText}).`;
            },
            
            saveQuizState() {
                if (!this.validatedStudentCode) return;
                const state = {
                    isCompleted: false, 
                    currentQuestionIndex: this.currentQuestionIndex,
                    score: this.score,
                    userAnswers: this.userAnswers,
                    skippedQuestions: this.skippedQuestions,
                    currentSkippedIndex: this.currentSkippedIndex,
                    shuffledQuestions: this.shuffledQuestions
                };
                try {
                    localStorage.setItem(`quizState_${this.validatedStudentCode}`, JSON.stringify(state));
                } catch (e) {
                    console.error("N√£o foi poss√≠vel salvar o estado do quiz:", e);
                }
            },

            loadQuizState(studentCode) {
                try {
                    const savedState = localStorage.getItem(`quizState_${studentCode}`);
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        if (!state.isCompleted) {
                            this.currentQuestionIndex = state.currentQuestionIndex;
                            this.score = state.score;
                            this.userAnswers = state.userAnswers;
                            this.skippedQuestions = state.skippedQuestions;
                            this.currentSkippedIndex = state.currentSkippedIndex;
                            this.shuffledQuestions = state.shuffledQuestions; 
                            return true;
                        }
                    }
                } catch (e) {
                    console.error("N√£o foi poss√≠vel carregar o estado do quiz:", e);
                    localStorage.removeItem(`quizState_${studentCode}`); 
                }
                return false; 
            },

            updateAttemptsDisplay(code) {
                const savedStateJSON = localStorage.getItem(`quizState_${code}`); 
                const finalReportJSON = localStorage.getItem(`quizReport_${code}`); 
                const correctName = this.studentData[code];
                
                if (correctName) {
                    this.elements.personalizedWelcome.textContent = `Seja bem-vindo(a), ${correctName}! Boa sorte!`;
                    this.elements.personalizedWelcome.style.display = 'block';
                }

                let state = null;
                let finalReport = null;
                try { if (savedStateJSON) state = JSON.parse(savedStateJSON); } catch (e) { localStorage.removeItem(`quizState_${code}`); }
                try { if (finalReportJSON) finalReport = JSON.parse(finalReportJSON); } catch (e) { localStorage.removeItem(`quizReport_${code}`); }

                let buttonsHtml = '';

                if (state && !state.isCompleted) {
                    buttonsHtml = `
                        <p style="font-weight: bold; color: #007bff;">Encontramos um progresso salvo para voc√™.</p>
                        <button class="btn continue-btn" style="background-color: #28a745;" onclick="quizApp.startQuiz(true)">Continuar Quiz</button>
                        <button class="btn restart-btn" style="background-color: #dc3545; margin-left: 10px;" onclick="quizApp.startQuiz(false)">Reiniciar (Perder Progresso)</button>
                    `;
                } else if (state && state.isCompleted) {
                    buttonsHtml = `
                        <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                        <button class="btn restart-btn" style="background-color: #dc3545;" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
                    `;
                } else {
                    buttonsHtml = `
                        <button class="start-btn" onclick="quizApp.startQuiz(false)">Start Quiz</button>
                    `;
                }

                if (finalReport) {
                    if (state && state.isCompleted) {
                        buttonsHtml = `
                            <p style="font-weight: bold; color: #007bff;">Voc√™ j√° completou este quiz.</p>
                            <button class="btn restart-btn" style="background-color: #dc3545;" onclick="quizApp.startQuiz(false)">Reiniciar Quiz</button>
                            <button class="btn continue-btn" style="background-color: #28a745; margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar Relat√≥rio</button>
                        `;
                    } else {
                        buttonsHtml += `
                            <button class="btn continue-btn" style="background-color: #28a745; margin-left: 10px;" onclick="quizApp.retrieveReport('${code}')">Resgatar √öltimo Relat√≥rio</button>
                        `;
                    }
                }
                
                this.elements.startActionsDiv.innerHTML = buttonsHtml;
            },
            
            restartQuiz() { window.location.reload(); },
            
            saveReport() {
                const studentName = this.validatedStudentName;
                const studentCode = this.validatedStudentCode;
                const score = this.elements.scoreDisplay.textContent;
                const percentage = this.elements.percentageDisplay.textContent;
                const classification = this.elements.classificationDisplay.textContent;
                
                const detailedReportHtml = this.generateFullReportHtml();
                const personalReportHtml = this.generatePersonalReportHtml();


                const fullHtmlContent = `
                    <!DOCTYPE html>
                    <html lang="pt-BR">
                    <head>
                        <meta charset="UTF-8">
                        <title>Relat√≥rio - ${studentName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                            h1, h3 { color: #007bff; }
                            h4 { color: #856404; }
                            p { margin: 5px 0; }
                            .report-question-item { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; page-break-inside: avoid; }
                            .option-item-report.correct { background-color: #d4edda; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                            .option-item-report.incorrect { background-color: #f8d7da; padding: 2px 5px; border-radius: 3px; font-weight: bold; }
                            .personal-summary-item { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; }
                            #print-personal-btn { display: none; } 
                        </style>
                    </head>
                    <body>
                        <h1>Relat√≥rio Final - ADVERBIAL CLAUSES</h1>
                        <p><strong>Nome:</strong> ${studentName}</p>
                        <p><strong>C√≥digo de Acesso:</strong> ${studentCode}</p>
                        <p><strong>Pontua√ß√£o:</strong> ${score}</p>
                        <p><strong>Percentual de Acerto:</strong> ${percentage}</p>
                        <p><strong>Classifica√ß√£o:</strong> ${classification}</p>
                        <hr>
                        <div id="personal-report-container">
                            ${personalReportHtml}
                        </div>
                        <hr>
                        <div id="full-report-container">
                            ${detailedReportHtml}
                        </div>
                    </body>
                    </html>
                `;

                const blob = new Blob([fullHtmlContent], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Relatorio_${studentName.replace(' ', '_')}_${studentCode}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            },

            init() {
                this.elements.studentCodeInput.addEventListener('input', (e) => {
                    const code = e.target.value.trim().toUpperCase();
                    if (this.studentData[code]) { 
                        this.updateAttemptsDisplay(code); 
                    } 
                    else { 
                        this.elements.startActionsDiv.innerHTML = '<button class=\"start-btn\" onclick=\"quizApp.startQuiz(false)\">Start Quiz</button>'; 
                        this.elements.personalizedWelcome.style.display = 'none';
                    }
                });
                
                this.elements.translateButton.onclick = () => this.translateQuestion();
                this.elements.performanceButton.onclick = () => this.showPerformance();
                this.elements.hintButton.onclick = () => this.showHint();
                this.elements.summaryButton.onclick = () => this.showSummary();
                this.elements.nextButton.onclick = () => this.nextQuestion();
                this.elements.skipButton.onclick = () => this.skipQuestion();
            }
        };

        window.onload = function() {
            quizApp.init();
        };
    </script>
</body>
</html>